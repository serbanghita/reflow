---
title: "Settlement Schedule Reflow â€” System Flow"
---

%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#1a1a2e', 'primaryTextColor': '#e0e0e0', 'primaryBorderColor': '#4a4a6a', 'lineColor': '#6c63ff', 'secondaryColor': '#16213e', 'tertiaryColor': '#0f3460', 'fontSize': '14px', 'fontFamily': 'monospace'}}}%%

flowchart TB
    %% â”€â”€â”€ SETUP PHASE (happens before reflow) â”€â”€â”€

    subgraph SETUP["ğŸ“‹ SETUP PHASE â€” Pre-defined, exists before reflow runs"]
        direction TB

        subgraph ACTORS_EXT["ğŸ¦ EXTERNAL ACTORS"]
            direction LR
            TD["ğŸ“Š Trade Desks<br>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br>Execute trades (T)<br>Agree on price/quantity<br>Payment NOT yet settled"]
            REG["âš–ï¸ Regulators<br>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br>Define operating hours<br>Declare blackout windows<br>Require compliance holds"]
            CP["ğŸ‘¥ Counterparties<br>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br>Committed to pay<br>Cash/securities pending<br>until settlementDate (T+N)"]
        end

        subgraph PLATFORM["ğŸ—ï¸ Capital33 Platform â€” Decomposes trades into tasks"]
            direction LR
            DECOMP["Trade Order arrives<br>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br>Platform generates a chain<br>of Settlement Tasks:<br><br>marginCheck<br>  â†’ fundTransfer<br>    â†’ complianceScreen<br>      â†’ disbursement<br>        â†’ reconciliation<br><br>Assigns each to a channel"]
        end

        subgraph STATIC_DATA["ğŸ’¾ CURRENT STATE (snapshot)"]
            direction LR
            TASKS["Settlement Tasks<br>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br>â€¢ taskReference<br>â€¢ settlementChannelId<br>â€¢ startDate / endDate<br>â€¢ durationMinutes<br>â€¢ dependsOnTaskIds[]<br>â€¢ isRegulatoryHold<br>â€¢ taskType<br>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br>âš¡ Tasks are INTERRUPTIBLE<br>Processing pauses outside<br>valid windows, resumes<br>in next available slot"]
            CHANNELS["Settlement Channels<br>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br>â€¢ operatingHours[]<br>  (pre-defined weekly schedule)<br>â€¢ blackoutWindows[]<br>  (pre-declared date ranges)<br>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br>ğŸ“Œ These are STATIC inputs<br>Already baked in before<br>reflow is called"]
            ORDERS["Trade Orders<br>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br>â€¢ tradeOrderNumber<br>â€¢ settlementDate (T+N)<br>  = the DEADLINE<br>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br>â° If tasks can't complete<br>before this date â†’<br>SLA BREACH"]
        end

        TD -->|"execute trade<br>(T date)"| DECOMP
        REG -->|"operating hours<br>blackout windows<br>compliance holds"| CHANNELS
        CP -->|"committed to pay<br>but not yet settled"| DECOMP
        DECOMP --> TASKS
    end

    %% â”€â”€â”€ TRIGGER â”€â”€â”€

    subgraph TRIGGER["âš¡ DISRUPTION â€” Triggers a reflow"]
        direction LR
        DIS["Something goes wrong:<br>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br>â€¢ Counterparty fund transfer late<br>â€¢ Channel goes offline<br>â€¢ New blackout window declared<br>â€¢ Unplanned maintenance<br>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br>â¬‡ï¸ Platform UPDATES the data<br>(adjusts task start, adds blackout)<br>then calls reflow with<br>CURRENT SNAPSHOT"]
    end

    %% â”€â”€â”€ REFLOW ENGINE â”€â”€â”€

    subgraph ENGINE["âš™ï¸ REFLOW ENGINE â€” Batch recalculation on current snapshot"]
        direction TB

        BATCH["ğŸ”„ BATCH RECALC MODEL<br>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br>NOT a real-time reactive system.<br>Reads current state â†’ computes<br>new valid schedule for ALL<br>non-pinned tasks at once.<br>Think: spreadsheet recalc."]

        subgraph PHASE1["Phase 1 â€” Build Dependency Graph"]
            DAG["ğŸ”— DAG Construction<br>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br>Nodes = settlement tasks<br>Edges = dependsOnTaskIds"]
            CYCLE["ğŸ” Cycle Detection<br>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br>If cycle found â†’ ERROR<br>'Circular dependency detected'"]
            TOPO["ğŸ“ TOPOLOGICAL SORT<br>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br>Kahn's Algorithm (BFS)<br>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br>1. Find tasks with 0 in-degree<br>2. Add to priority queue<br>3. Process each:<br>   â€¢ Schedule it<br>   â€¢ Decrement neighbor in-degrees<br>   â€¢ Enqueue newly 0-degree tasks<br>4. Tie-break: earlier startDate<br>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br>Guarantees: every task is<br>scheduled AFTER all its<br>upstream dependencies"]
            DAG --> CYCLE --> TOPO
        end

        subgraph PHASE2["Phase 2 â€” Schedule Each Task (in topo order)"]
            direction TB
            PIN{"Is task<br>isRegulatoryHold?"}
            SKIP["ğŸ”’ PINNED<br>Keep original dates<br>Cannot move<br>Still acts as dependency<br>source for downstream"]

            EARLIEST["Compute Earliest Start<br>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br>effectiveStart = max(<br>  â€¢ latest dep endDate âœ…<br>  â€¢ channel nextAvailable âœ…<br>  â€¢ next operating window open âœ…<br>)<br>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br>Then snap forward past any<br>blackout windows"]

            subgraph CONSTRAINTS["ğŸš§ CONSTRAINT CHECK ORDER"]
                direction TB
                C1["1ï¸âƒ£ Dependencies<br>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br>All upstream tasks<br>must be complete"]
                C2["2ï¸âƒ£ Channel Conflicts<br>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br>No overlapping tasks<br>on same channel"]
                C3["3ï¸âƒ£ Operating Hours<br>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br>Process only during<br>pre-defined market windows"]
                C4["4ï¸âƒ£ Blackout Windows<br>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br>Skip pre-declared<br>maintenance/regulatory blocks"]
                C1 --> C2 --> C3 --> C4
            end

            CALC["â±ï¸ Calculate End Date<br>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br>calculateEndDateWithOperatingHours(<br>  effectiveStart,<br>  durationMinutes,<br>  operatingHours,<br>  blackoutWindows<br>)<br>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br>Consumes work-minutes ONLY<br>within valid operating windows.<br>Skips nights, weekends, blackouts.<br>Returns exact end timestamp."]

            UPDATE["ğŸ“ Update State<br>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br>â€¢ channel.nextAvailable = endDate<br>â€¢ Record: what moved, by how much<br>â€¢ Record: WHY it moved<br>  (dep delay / conflict / blackout)"]

            PIN -->|Yes| SKIP
            PIN -->|No| EARLIEST
            EARLIEST --> CONSTRAINTS
            CONSTRAINTS --> CALC
            CALC --> UPDATE
        end

        subgraph PHASE3["Phase 3 â€” Validate & Report"]
            direction LR
            VALIDATE["âœ… Post-Reflow Validation<br>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br>Verify the output schedule:<br>â€¢ No channel overlaps<br>â€¢ All deps satisfied<br>â€¢ All work within op hours<br>â€¢ No blackout violations<br>â€¢ Regulatory holds untouched"]
            METRICS["ğŸ“Š Metrics (Bonus)<br>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br>â€¢ Î£ total delay introduced<br>â€¢ Count of tasks affected<br>â€¢ Channel utilization %<br>â€¢ SLA breach flags<br>  (tasks missing T+N deadline)"]
        end

        BATCH --> DAG
        TOPO --> PIN
        UPDATE -->|"next task<br>in topo order"| PIN
        UPDATE --> VALIDATE
        VALIDATE --> METRICS
    end

    %% â”€â”€â”€ OUTPUTS â”€â”€â”€

    subgraph OUTPUTS["ğŸ“¤ OUTPUTS"]
        direction LR
        SCHED["Updated Schedule<br>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br>All tasks with<br>new startDate / endDate"]
        CHANGES["Change Log<br>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br>Per task:<br>â€¢ original dates<br>â€¢ new dates<br>â€¢ delta (how much)<br>â€¢ reason (why)"]
        ERRORS["Errors / Warnings<br>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br>â€¢ Circular deps<br>â€¢ Impossible schedules<br>â€¢ SLA breaches<br>  (missed T+N deadline)"]
    end

    subgraph CONSUMERS["ğŸ‘¤ INTERNAL CONSUMERS"]
        direction LR
        OPS["ğŸ–¥ï¸ Operations Team<br>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br>Reviews new schedule<br>Acts on SLA breaches<br>Escalates if needed"]
        COMP["ğŸ“‹ Compliance Team<br>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br>Verifies regulatory holds<br>were not moved<br>Reviews blackout adherence"]
    end

    %% â”€â”€â”€ CONNECTIONS â”€â”€â”€

    SETUP --> DIS
    TASKS --> ENGINE
    CHANNELS --> ENGINE
    ORDERS --> ENGINE
    DIS -->|"updated snapshot"| ENGINE

    ENGINE --> SCHED
    ENGINE --> CHANGES
    ENGINE --> ERRORS

    SCHED --> OPS
    CHANGES --> OPS
    ERRORS --> OPS
    CHANGES --> COMP
    ERRORS --> COMP

    %% â”€â”€â”€ STYLES â”€â”€â”€

    classDef actorExt fill:#2d1b69,stroke:#8b5cf6,stroke-width:2px,color:#e0e0e0
    classDef platform fill:#1a3a3a,stroke:#2dd4bf,stroke-width:2px,color:#e0e0e0
    classDef input fill:#1a3a1a,stroke:#4ade80,stroke-width:2px,color:#e0e0e0
    classDef output fill:#3a1a1a,stroke:#f87171,stroke-width:2px,color:#e0e0e0
    classDef engine fill:#1a1a3a,stroke:#6c63ff,stroke-width:2px,color:#e0e0e0
    classDef disruption fill:#4a2a0a,stroke:#fb923c,stroke-width:2px,color:#e0e0e0
    classDef topo fill:#0a3a4a,stroke:#22d3ee,stroke-width:3px,color:#e0e0e0
    classDef constraint fill:#3a2a1a,stroke:#fbbf24,stroke-width:2px,color:#e0e0e0
    classDef pinned fill:#4a1a2a,stroke:#f472b6,stroke-width:2px,color:#e0e0e0
    classDef batch fill:#2a1a3a,stroke:#c084fc,stroke-width:3px,color:#e0e0e0
    classDef consumer fill:#1b4d69,stroke:#5cb8f6,stroke-width:2px,color:#e0e0e0

    class CP,TD,REG actorExt
    class DECOMP platform
    class TASKS,CHANNELS,ORDERS input
    class SCHED,CHANGES,ERRORS output
    class DIS disruption
    class TOPO topo
    class C1,C2,C3,C4 constraint
    class SKIP pinned
    class BATCH batch
    class OPS,COMP consumer
